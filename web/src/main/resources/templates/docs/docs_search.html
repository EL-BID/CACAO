<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}" th:lang="${lang}">
<head th:replace="fragments/page_fragments :: header(more_links=~{this::link}, more_scripts=~{this::script[src]})">
	<!-- Although the entire head will be replaced, its necessary to establish the charset
	for all static content before the Thymeleaf processing. -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" class="ui" href="/css/tabulator_semantic-ui.min.css">
	<script src="/js/tabulator.min.js"></script>
	<script src="/js/luxon.min.js"><</script>
</head>
<body>
	<!-- Fix to avoid overlap from the Menu -->
	<div>
		<br>
	</div>
	<div class="ui container">
      <div class="ui breadcrumb">
        <a class="section" th:text="#{menu.homepage}" th:href="@{/cards}">Home</a>
        <div class="divider"> / </div>
        <div class="active section" th:text="#{docs.history}">Doc Errors</div>
      </div>
  
		<h2 class="ui header">
			<i class="archive icon"></i>
			<div class="content" th:text="#{docs.history}">All Uploads</div>
		</h2>
		<div id="table" class="ui orange compact table"></div>
		<div class="ui column right floated">
			<div class="ui right floated primary labeled icon">
				<a th:href="@{/docs}" class="ui primary button"><i class="plus icon"></i><span th:text="#{docs.main.upload}">Upload Documents</span></a>
			</div>
		</div>
	</div>
 
<script th:nonce="${cspNonce}" th:inline="javascript">
dateFormatter = function(cell, formatterParams, onRendered) {
	var newDate= (window.DateTime || luxon.DateTime).fromISO(cell.getValue())
	if(newDate.isValid) {
		return newDate.toFormat('yyyy-MM-dd HH:mm:ss')
	}
	return cell.getValue()
}

let showSituationHistory = function(e, cell) {
	window.location.replace([[@{/doc/situations/}]] + cell.getRow().getIndex());			
}

let showErrorMessages = function(e, cell) {
	window.location.replace([[@{/doc/errors/}]] + cell.getRow().getIndex());			
}	

let downloadFile = function(e, cell) {
	window.location.replace([[@{/doc/download/}]] + cell.getRow().getIndex());			
}
	
let situationsIcon = function(cell, formatterParams){ return "<i class='file alternate outline icon'></i>"};
let errorsIcon = function(cell, formatterParams){ return "<i class='warning sign icon'></i>"};
let downloadIcon = function(cell, formatterParams){ return "<i class='save icon'></i>"};

let table = new Tabulator('#table', {
	index: 'id',
	layout: "fitDataFill", //fit columns to width of table (optional)
    pagination: true,
	paginationMode: "remote", //enable remote pagination
		ajaxURL: /*[[@{/api/docs_search}]]*/ "/api/docs_seach", //set url for ajax request
	paginationSize: 5,
	ajaxContentType: "json",
	filterMode:"remote",
	sortMode: "remote",
	headerFilterLiveFilterDelay:700,
	ajaxURLGenerator: function(url, config, params ){
		console.log(config)
		console.log(params)
		p= new URLSearchParams()
		p.set('page', params.page)
		p.set('size', params.size)
		p.set('filter', JSON.stringify(params.filter))
		if(params.sort.length>0) {
			p.set('sortby', params.sort[0].field)
			p.set('sortorder', params.sort[0].dir)
		}
		return url + '?' + p.toString()
	},
    paginationSizeSelector:[10, 25, 50],
    locale:'xx',
    langs:{
        "xx":{
            "pagination":{
                "first":/*[[#{pagination.first.button}]]*/ "First",
                "first_title":/*[[#{pagination.first.tooltip}]]*/ "First Page",
                "last":/*[[#{pagination.last.button}]]*/ "Last",
                "last_title":/*[[#{pagination.last.tooltip}]]*/ "Last Page",
                "prev":/*[[#{pagination.prev.button}]]*/ "Prev",
                "prev_title":/*[[#{pagination.prev.tooltip}]]*/ "Prev Page",
                "next":/*[[#{pagination.next.button}]]*/ "Next",
                "next_title":/*[[#{pagination.next.tooltip}]]*/ "Next Page",
                "all":/*[[#{pagination.all}]]*/ "All",
                "page_size":/*[[#{pagination.page.size}]]*/ "Page Size",
                "page_title":/*[[#{pagination.page.tooltip}]]*/ "Show Page"
            }
        }
    },

	columns:[ //Define Table Columns
		{title: /*[[#{doc.user}]]*/ "User", field:"user"},
		{title: /*[[#{taxpayer.id}]]*/ "Tax Payer Id", field:"taxPayerId"},
		{title: /*[[#{doc.taxperiod}]]*/ "Tax Period", field:"taxPeriodNumber"},
		{title: /*[[#{doc.template}]]*/ "Template", field:"templateName"},
		{title: /*[[#{doc.timestamp}]]*/ "Date/time uploaded", field:"timestamp", formatter: dateFormatter},
		{title: /*[[#{doc.situation}]]*/ "Situation", field:"situation"},
		//{title: /*{{#doc.id}}} */ "Document Id", field:"id", headerFilter:this.headerFilter},
		{formatter:situationsIcon, width:50, cellClick: showSituationHistory, tooltip : /*[[#{doc.situation.history}]]*/, headerSort:false},
		{formatter:errorsIcon, width:50, cellClick: showErrorMessages, tooltip : /*[[#{doc.error.message}]]*/, headerSort:false},
		{formatter:downloadIcon, width:50, cellClick: downloadFile, tooltip : /*[[#{doc.download}]]*/, headerSort:false}
	]
})
</script>
</body>
</html>
    
