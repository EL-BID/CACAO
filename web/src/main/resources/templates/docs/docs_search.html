<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}" th:lang="${lang}">
<head th:replace="fragments/page_fragments :: header(more_links=~{this::link}, more_scripts=~{this::script[src]})">
	<!-- Although the entire head will be replaced, its necessary to establish the charset
	for all static content before the Thymeleaf processing. -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" class="ui" href="/css/tabulator_semantic-ui.min.css">
	<script src="/js/tabulator.min.js"></script>
	<script src="/js/luxon.min.js"><</script>
</head>
<body>
	<!-- Fix to avoid overlap from the Menu -->
	<div>
		<br>
	</div>
	<div class="ui container">
		<h2 class="ui header">
			<i class="archive icon"></i>
			<div class="content" th:text="#{docs.history}">All Uploads</div>
		</h2>
			<div id="app">
				<div id="table" class="ui orange table"></div>
			</div>
		<div class="ui column right floated">
			<div class="ui right floated primary labeled icon">
				<a th:href="@{/docs}" class="ui button"><i class="plus icon"></i><span th:text="#{docs.main.upload}">Upload Documents</span></a>
			</div>
		</div>
	</div>
 
<script th:nonce="${cspNonce}" th:inline="javascript">
dateFormatter = function(cell, formatterParams, onRendered) {
	var newDate= (window.DateTime || luxon.DateTime).fromISO(cell.getValue())
	if(newDate.isValid) {
		return newDate.toFormat('yyyy-MM-dd HH:mm:ss')
	}
	return cell.getValue()
}

var app = new Vue({
	el: '#app',
	data: {
		table: null,
		headerFilter: false
	},
	methods: {
		showSituationHistory(e, cell) {
			console.log('edit  ' + cell.getRow().getIndex() )
			window.location.replace([[@{/doc/situations/}]] + cell.getRow().getIndex());			
		},
		showErrorMessages(e, cell) {
			console.log('edit  ' + cell.getRow().getIndex() )
			window.location.replace([[@{/doc/errors/}]] + cell.getRow().getIndex());			
		},	
	},	
	mounted() {
		var situationsIcon = function(cell, formatterParams){ return "<i class='file alternate outline icon'></i>"};
		var errorsIcon = function(cell, formatterParams){ return "<i class='warning sign icon'></i>"};
		this.table = new Tabulator('#table', {
			index: 'id',
			layout: "fitColumns", //fit columns to width of table (optional)
		    pagination: true,
			paginationMode: "remote", //enable remote pagination
    		ajaxURL: /*[[@{/api/docs_search}]]*/ "/api/docs_seach", //set url for ajax request
			paginationSize: 5,
			ajaxContentType: "json",
			filterMode:"remote",
			sortMode: "remote",
			headerFilterLiveFilterDelay:700,
		    persistence:{
				columns:true,
			},			
			persistenceID:"all_documents_persistence",
			ajaxURLGenerator: function(url, config, params ){
				console.log(config)
				console.log(params)
				p= new URLSearchParams()
				p.set('page', params.page)
				p.set('size', params.size)
				p.set('filter', JSON.stringify(params.filter))
				if(params.sort.length>0) {
					p.set('sortby', params.sort[0].field)
					p.set('sortorder', params.sort[0].dir)
				}
				console.log(p.toString())
				return url + '?' + p.toString()
			},
			columns:[ //Define Table Columns
				{title: /*[[#{doc.user}]]*/ "User", field:"user", headerFilter:this.headerFilter},
				{title: /*[[#{taxpayer.id}]]*/ "Tax Payer Id", field:"taxPayerId" },
				{title: /*[[#{doc.taxperiod}]]*/ "Tax Period", field:"taxPeriodNumber" },
				{title: /*[[#{doc.template}]]*/ "Template", field:"templateName" , headerFilter:this.headerFilter},
				{title: /*[[#{doc.timestamp}]]*/ "Date/time uploaded", field:"timestamp", formatter: dateFormatter, headerFilter:this.headerFilter},
				{title: /*[[#{doc.situation}]]*/ "Situation", field:"situation", headerFilter:this.headerFilter},
				//{title: /*{{#doc.id}}} */ "Document Id", field:"id", headerFilter:this.headerFilter},
				{formatter:situationsIcon, width:50, cellClick: this.showSituationHistory, tooltip : /*[[#{doc.situation.history}]]*/},
				{formatter:errorsIcon, width:50, cellClick: this.showErrorMessages, tooltip : /*[[#{doc.error.message}]]*/}
			]
		})
	}
})
</script>
</body>
</html>
    
