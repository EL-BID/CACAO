<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}" th:lang="${lang}">
<head th:replace="fragments/page_fragments :: header(more_links=~{this::link}, more_scripts=~{this::script[src]})">
	<!-- Although the entire head will be replaced, its necessary to establish the charset
	for all static content before the Thymeleaf processing. -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" class="ui" href="/css/tabulator_semantic-ui.min.css">
	<script src="/js/tabulator.min.js"></script>
	<script src="/js/luxon.min.js"><</script>
</head>
<body>
	<!-- Fix to avoid overlap from the Menu -->
	<div>
		<br>
	</div>
	<div class="ui container">
        <div class="ui breadcrumb">
          <a class="section" th:text="#{menu.homepage}" th:href="@{/cards}">Home</a>
          <div class="divider"> / </div>
          <div class="active section" th:text="#{templates}">All Templates</div>
        </div>
		<h2 class="ui header">
			<i class="file alternate outline icon"></i>
			<div class="content" th:text="#{templates}">All Templates</div>
		</h2>
		<div id="table" class="ui orange table"></div>
		<div class="ui column right floated"  sec:authorize="hasRole('ROLE_TAX_TEMPLATE_WRITE')">
			<div class="ui right floated primary labeled icon">
				<a th:href="@{/templates/add}" class="ui blue button"><i class="plus icon"></i><span th:text="#{template.new}">New Template</span></a>
			</div>
		</div>
	</div>
 
<script th:nonce="${cspNonce}" th:inline="javascript">
[# sec:authorize="hasRole('ROLE_TAX_TEMPLATE_WRITE')"]
var editRow = function(e, cell) {
	e.stopPropagation();
	window.location.replace([[@{/templates/}]] +  cell.getRow().getIndex() + "/edit");
}
var editIcon = function(cell, formatterParams){ return "<i class='edit icon'></i>"};
[/]
var tableData = /*[[${templates}]]*/ null;
let periodicityLookup = {
    [# th:each="i :  ${T(org.idb.cacao.api.Periodicity).values()}"] 
    [# th:text="${i.name()}"/]: [# th:text="#{${i}}"/], 
    [/]
}
table = new Tabulator('#table', {
	index: 'id',
	layout: "fitData", //fit columns to width of table (optional)
    pagination: true,
    paginationSize: /*[[${@environment.getProperty('default.page.size')}]]*/ 15,
	paginationSizeSelector:[5, 10, /*[[${@environment.getProperty('default.page.size')}]]*/ 15, 25, 50, true],
    footerElement: "<button id='filter' class='ui left floated compact button' href='javascript: filter();'><i class='icon filter'></i>[(#{filters})]</button>",
    locale:'xx',
    langs:{
        "xx":{
            "pagination":{
                "first":/*[[#{pagination.first.button}]]*/ "First",
                "first_title":/*[[#{pagination.first.tooltip}]]*/ "First Page",
                "last":/*[[#{pagination.last.button}]]*/ "Last",
                "last_title":/*[[#{pagination.last.tooltip}]]*/ "Last Page",
                "prev":/*[[#{pagination.prev.button}]]*/ "Prev",
                "prev_title":/*[[#{pagination.prev.tooltip}]]*/ "Prev Page",
                "next":/*[[#{pagination.next.button}]]*/ "Next",
                "next_title":/*[[#{pagination.next.tooltip}]]*/ "Next Page",
                "all":/*[[#{pagination.all}]]*/ "All",
                "page_size":/*[[#{pagination.page.size}]]*/ "Page Size",
                "page_title":/*[[#{pagination.page.tooltip}]]*/ "Show Page"
            }
        }
    },
	data: tableData,
	columns:[ //Define Table Columns
		[# sec:authorize="hasRole('ROLE_TAX_TEMPLATE_WRITE')"]
		{formatter:editIcon, tooltip: /*{{#{edit}}} */ "Edit", cellClick: editRow, headerSort:false, width:45},
		[/]
		{title: /*[[#{template.name}]]*/ "Name", field:"name", minWidth: 140},
		{title: /*[[#{template.group}]]*/ "Group", field:"group", minWidth: 100},
		{title: /*[[#{template.version}]]*/ "Version", field:"version", minWidth: 100},
		{title: /*[[#{template.periodicity}]]*/ "Periodicity", field:"periodicity", formatter:"lookup", formatterParams: periodicityLookup, minWidth:150 },
		{title: '<i class="asterisk icon"></i>', titleFormatter:'html', tooltip:/*[[#{field.required}]]*/ "Required", field:"required",  
			formatter:"tickCross", formatterParams: { crossElement:false}, width:40}
	]
})
table.on('rowClick', function(e, row) {
	if( e.target.classList.contains('edit')) {
		return
	}
	window.location.replace([[@{/templates/}]] + row.getIndex());
})

let showHeaderFilter = false
table.on("tableBuilt", function(){
  $('#filter').click( function() {
      showHeaderFilter = !showHeaderFilter
      table.getHeaderFilters().forEach( t => table.setHeaderFilterValue(t.field, ''))
      let cols = ['name', 'group', 'version']
      cols.forEach( name =>
        table.updateColumnDefinition(name, { headerFilter: showHeaderFilter})
      )
      if(showHeaderFilter)
        table.updateColumnDefinition('periodicity', { headerFilter: 'select', headerFilterParams: { values: periodicityLookup } })
      else {
    	table.updateColumnDefinition('periodicity', { headerFilter: false})
      }
  })
})
</script>
</body>
</html>
    
