<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}" th:lang="${lang}">
<head th:replace="fragments/page_fragments :: header">
<!-- Although the entire head will be replaced, its necessary to establish the charset
	for all static content before the Thymeleaf processing. -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
	<!-- Fix to avoid overlap from the Menu -->
	<div>
		<br>
	</div>
	<div class="ui container">
		<h2 class="ui header">
			<i class="user icon"></i>
			<div class="content" th:text="#{user.new}">New User</div>
		</h2>
		<div id="app">
		<div class="ui center aligned container">
			<div class="ui orange segment">
				<form class="ui large form" :class="{ error: msg }" action="#" th:action="@{/api/user}" th:object="${user}" method="post" @submit.prevent="processForm">
						<h4 class="ui header" style="margin-bottom: 0px; text-transform: uppercase;">
							<div class="content" th:text="#{user.name}">User Name</div>
						</h4>
						<div class="field">
							<input type="text" v-model="user.name" class="field" id="name" placeholder="Name" th:placeholder="#{user.name}">
							<span class="ui error message">{{ msg.name }}</span>
						</div>
						<h4 class="ui header" style="margin-bottom: 0px; text-transform: uppercase;">
							<div class="content" th:text="#{user.login}">"Login</div>
						</h4>
						<div class="ui form">
							<input type="text" v-model="user.login" class="form-control" id="login" placeholder="Login" th:placeholder="#{user.login}">
							<span v-if="msg.login" class="ui error message">{{ msg.login }}</span>
						</div>
						<th:block th:unless="${omit_password}">
							<h4 class="ui header" style="margin-bottom: 0px; display:inline-block; text-transform: uppercase;">
								<i class="lock icon"></i>
								<div class="content" th:text="#{user.password}">Password</div>
							</h4>
							<div class="ui form">
								<input type="password" v-model="user.password" class="form-control" id="password" placeholder="Password" th:placeholder="#{user.password}">
								<span v-if="msg.password" class="ui error message">{{ msg.password }}</span>
							</div>
							<h4 class="ui header" style="margin-bottom: 0px; display:inline-block; text-transform: uppercase;">
								<i class="lock icon"></i>
								<div class="content" th:text="#{user.password.confirm}">Confirm Password</div>
							</h4>
							<div class="ui form">
								<input type="password" v-model="user.confirmPassword" class="form-control" id="confirmPassword" placeholder="Password" th:placeholder="#{user.password.confirm}">
								<span v-if="msg.confirmPassword" class="ui warning message">{{ msg.confirmPassword }}</span>
							</div>
						</th:block>
						<h4 class="ui header" style="margin-bottom: 0px; text-transform: uppercase;">
							<div class="content" th:text="#{user.profile}">Profile</div>
						</h4>
						<div class="ui form">
							<select v-model="user.profile" class="ui fluid dropdown">
								<option disabled value="">Select a profile</option>
								<option th:each="i : ${T(org.idb.cacao.web.entities.UserProfile).values()}" th:value="${i.name()}" th:text="#{${i}}"></option>
							</select>
							<span v-if="msg.profile" class="ui warning message">{{ msg.profile }}</span>
						</div>
					<div class="row">
						<div class="ui segment">
							<input type="submit" class="ui blue submit button" th:value="#{user.add.title}" value="Add User">
							<input type="button" class="ui button" th:value="#{cancel}" value="Cancel" id="cancel" @click.prevent="cancel">
						</div>
					</div>
				</form>
			</div>
		</div>
		</div>
	</div>
	<div th:replace="fragments/modals :: successful">MODAL DIALOG FOR SUCCESSFUL ALERT</div>
	<div th:replace="fragments/modals :: failed">MODAL DIALOG FOR FAILURE ALERT</div>

<script th:nonce="${cspNonce}" th:inline="javascript">
var app = new Vue({
	el: '#app',
	data: {
		user: {
			name: '',
			login: '',
			password: '',
			confirmPassword: '',
			profile: ''
		},
		msg: []
	},
	methods: {
		cancel() {
			window.location.replace([[@{/users}]])
		},
		processForm() {
			$.ajax({
   			    url: [[@{/api/user}]],
   			    type: 'POST',
   			    dataType: 'json',
   			    contentType: 'application/json',
   			    data: JSON.stringify(this.user),
   			    cache: false,    
   				success: function(result) {
   					$('#modal_successful').modal('show')
   					setTimeout(function(){
   						window.location = [[@{/users}]]
   					}, 2000);
   				},
   				error: function(e) {
   					var msg = e.responseText.replace(/\n/g, "<br />");
   					$('#modal_failed').find('.description').html(msg)
   					$('#modal_failed').modal('show')
   					console.log("ERROR : "+msg);
   				}
   			});			 
		}
	}, 
	watch: {
		'user.name': function(value, old) {
			delete this.msg['name']
			if(value.split(' ').length<2) {
				this.msg['name']='Name must have 2 parts'
			}
		},
		'user.login': function(value, old) {
			delete this.msg['login']
			const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
		    if( !re.test(String(value).toLowerCase()) ) {
		    	this.msg['login'] = 'Login must be a valid email'
		    } 
		},
		'user.password': function(value, old) {
			delete this.msg['password']
			if(value.length<6) {
				this.msg['password'] = 'Minimum 6 characters'
			}
		}
	}
})
  
  </script>
</body>
</html>