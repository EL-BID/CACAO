<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}"
	th:lang="${lang}">
<head
	th:replace="fragments/page_fragments :: header(more_links=~{this::link}, more_scripts=~{this::script[src]})">
<!-- Although the entire head will be replaced, its necessary to establish the charset
	for all static content before the Thymeleaf processing. -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" class="ui"
	href="/css/tabulator_semantic-ui.min.css">
<script src="/js/tabulator.min.js"></script>
<script src="/js/luxon.min.js"></script>
<script src="/js/vega.min.js"></script>
<script src="/js/vega-lite.min.js"></script>
<script src="/js/vega-embed.min.js"></script>
</head>
<body>
	<!-- Fix to avoid overlap from the Menu -->
	<div>
		<br>
	</div>
	<div class="ui container">
		<div class="ui breadcrumb">
			<a class="section" th:text="#{menu.homepage}" th:href="@{/cards}">Home</a>
			<div class="divider">/</div>
			<div class="active section" th:text="#{taxpayers.analysis}">Analysis</div>
		</div>
		<h2 class="ui header">
			<i class="stream icon"></i> <span class="content"
				th:text="#{taxpayers.analysis.general}">General Analysis</span>
		</h2>
		<div class="ui container">
			<div class="ui orange segment">
				<form action="#" name="form" id="form" th:action="@{/general-analysis-data}"
					class="ui form" method="post">

					<div class="ui field" id="qualifiersView">
						<label th:text="#{taxpayers.analysis.general.qualifiers}">Qualifiers</label>
						<select class="ui dropdown" id="qualifiers">
							<option value="qualifier1" th:text="#{taxpayer.qualifier.1}">Qualifier
								1</option>
							<option value="qualifier2" th:text="#{taxpayer.qualifier.2}">Qualifier
								2</option>
							<option value="qualifier3" th:text="#{taxpayer.qualifier.3}">Qualifier
								3</option>
							<option value="qualifier4" th:text="#{taxpayer.qualifier.4}">Qualifier
								4</option>
							<option value="qualifier5" th:text="#{taxpayer.qualifier.5}">Qualifier
								5</option>
						</select>
					</div>

					<div class="ui field" id="qualifierValuesView">
						<label th:text="#{taxpayers.analysis.general.qualifier.values}">Qualifier
							Value</label> <select class="ui dropdown" id="qualifierValues">
						</select>
					</div>

					<div class="ui field">
						<label th:text="#{base.period}">Base Period</label> <select
							class="ui dropdown" id="year">
						</select>
					</div>

					<div class="row">
						<input type="submit" class="ui blue button" th:value="#{search}"
							value="Search">
					</div>
				</form>
			</div>
		</div>
 
		<div id="dataView" style="display: none">
			<div class="ui container grid">
				<div class="ten wide column unbounded" id="graphView">
					<div id="vis">
						<!-- Display graphics -->
					</div>
				</div>
				<div class="six wide column unbounded" id="tableView">
					<div id="table">
						<!-- Display table -->
					</div>
				</div>
			</div>
		</div>
		
	</div>
	
	<div th:replace="fragments/modals :: successful">MODAL DIALOG FOR
		SUCCESSFUL ALERT</div>
	<div th:replace="fragments/modals :: failed">MODAL DIALOG FOR FAILURE
		ALERT</div>

	<script th:nonce="${cspNonce}" th:inline="javascript">
	
		decimalFormatter = function(cell, formatterParams, onRendered) {
			const format = (num, decimals) => num.toLocaleString(/*[[${language}]]*/ 'en-US', {
		   		minimumFractionDigits: 2,      	
		   		maximumFractionDigits: 2,	
			});			
			return format(cell.getValue()) + "%";
		}
	
		$('#qualifiers').on('change', function() {
			updateQualifiersValues();	
			$("#dataView").hide();			
     	});
		
		$('#qualifierValues').on('change', function() {
			$("#dataView").hide();
	    });
		
		$('#year').on('change', function() {
			$("#dataView").hide();
	    });
		
		function updateQualifiersValues() {
			$('#qualifierValues').find('option').remove();
			$.get('/api/analysis/qualifiers', 
					{ qualifier: $('#qualifiers').val() } ,  //data to submit
			    function (data, status, xhr) {
					$.each(data, function (i, item) {						
					    $('#qualifierValues').append($('<option>', { 
					        value: item,
					        text : item
					    }));					    
					});		
			    }
			);
		}		
		
		function updateYears() {		
			$('#year').find('option').remove();
			$.get('/api/analysis/years',
			    function (data, status, xhr) {
					$.each(data, function (i, item) {						
					    $('#year').append($('<option>', { 
					        value: item,
					        text : item
					    }));					    
					});		
			    }
			);			
		}
		
		$(document).ready(function() {
			updateQualifiersValues();
			updateYears();
			$('.ui.form').form({
				fields: {
					year: {
	                	identifier  : 'year',
	                	rules: [{
	                    	type   : 'empty',
	                    	prompt : /*[[#{year.missing}]]*/ ''
	                  	}]
	              	},
	          	},
				onSuccess: (function(event,fields){
					event.preventDefault();				
					updateData();
					//showGraphics();
	          	})
	        });
	    });
		
		function updateData() {

			$.get('/api/analysis/general-analysis', 
					{ qualifier: $('#qualifiers').val(),
						qualifierValue: $('#qualifierValues').val(),
						year: $('#year').val(),				
					} ,  //data to submit
			    function (data, status, xhr) {
					console.log(data);
					showTable(data.outliers);
					$("#dataView").show();
					var width = $("#graphView").width() * .7;
					window.dispatchEvent(new Event('resize'));
					showGraphics(data, width);
					window.dispatchEvent(new Event('resize'));
			    }
			);
			
		}
		
		function showGraphics(data, width) {
			
	      var yourVlSpec = {
			$schema: 'https://vega.github.io/schema/vega-lite/v5.json',
    	        description: 'A box plot chart with statements data',    	        
    	        "width": width,
    	        //"width": "container",
    	        "height": data.items.length * 50,
    	        "data": { "values": data.items },
    	        "config": {"mark": {"tooltip": true}},
    	        "mark": {"type": "rule"},
    	        "encoding": {
    	          "y": {"field": "statementName", "type": "nominal", "title": "Statement",
    	                "axis": {"title": null, "labelFontSize": 10, "labelFontWeight": "bold", "labelLimit": 100}}
    	        },
    	        "layer": [
    	          {
    	            "mark": {"type": "rule"},
    	            "encoding": {
    	              "x": {
    	                "field": "min",
    	                "type": "quantitative",          
    	                "scale": {
    	                  "zero": false,
    	                  "domain": [data.scaleMin, data.scaleMax]
    	                },
    	                "title": "Min",
    	                "axis": {"title": null}
    	              },
    	              "x2": {"field": "max", "title": "Max"}
    	            }
    	          },
    	          {
    	            "mark": {"type": "bar", "size": 18},
    	            "encoding": {
    	              "x": {"field": "q1", "type": "quantitative", "title": "Q1"},
    	              "x2": {"field": "q3", "title": "Q3"},
    	              "color": {"field": "statementName", "type": "nominal", "legend": null, "title": "Statement"}
    	            }
    	          },
    	          {
    	            "mark": {"type": "tick", "color": "white", "size": 18},
    	            "encoding": {"x": {"field": "median", "type": "quantitative", "title": "Median"}}
    	          },
    	          {
    	            "transform": [{"flatten": ["normalizedOutliers"]}],
    	            "mark": {"type": "point", "style": "boxplot-outliers"},
    	            "encoding": {
    	              "x": {"field": "normalizedOutliers.value", "type": "quantitative", "title": "Outlier"}, 
    	              		"tooltip":{"field": "normalizedOutliers.taxpayerName"}}
    	          }
    	        ]
   	        };	      
			vegaEmbed('#vis', yourVlSpec, {"actions": { "export": true, "source": false, "compiled": false, "editor": true } });
			$("#vis").show()
		}
		
		let tooltip = function(e, cell) {
			console.log(cell);
			alert(cell);			
			row = cell.getRow();
            id = row.getCell("taxpayerId");
            return id.getValue(); //return cells "field - value";						
		}
		
		function showTable(values) {
			new Tabulator('#table', {
				index: 'id',
				columnDefaults:{
					tooltip:function(cell) {
						row = cell.getRow();
						id = row.getCell("taxpayerId");
			            return "Id: " + id.getValue();
			        },
					headerTooltip:false,					
			    },				    
				layout: "fitDataFill", //fit columns to width of table (optional)
			    pagination: true,
				paginationMode: "local", //enable local pagination
				paginationSize: /*[[${@environment.getProperty('default.page.size')}]]*/ 15,
				paginationSizeSelector:[5, 10, /*[[${@environment.getProperty('default.page.size')}]]*/ 15, 25, 50, true],
				data: values,
				locale:'xx',
				langs:{
			        "xx":{
			            "pagination":{
			                "first":/*[[#{pagination.first.button}]]*/ "First",
			                "first_title":/*[[#{pagination.first.tooltip}]]*/ "First Page",
			                "last":/*[[#{pagination.last.button}]]*/ "Last",
			                "last_title":/*[[#{pagination.last.tooltip}]]*/ "Last Page",
			                "prev":/*[[#{pagination.prev.button}]]*/ "Prev",
			                "prev_title":/*[[#{pagination.prev.tooltip}]]*/ "Prev Page",
			                "next":/*[[#{pagination.next.button}]]*/ "Next",
			                "next_title":/*[[#{pagination.next.tooltip}]]*/ "Next Page",
			                "all":/*[[#{pagination.all}]]*/ "All",
			                "page_size":/*[[#{pagination.page.size}]]*/ "Page Size",
			                "page_title":/*[[#{pagination.page.tooltip}]]*/ "Show Page"
			            }
			        }
			    },	
			    placeholder: /*[[#{no.data.available}]]*/ "No data available", //display message to user on empty table
			    groupBy:"statementName",
			    groupHeader:function(value, count, data, group){
			        //value - the value all members of this group share
			        //count - the number of rows in this group
			        //data - an array of all the row data objects in this group
			        //group - the group component for the group
			        return value;
			    },
				columns:[ //Define Table Columns
					{title: /*[[#{account.statement}]]*/ "Statement", field:"statementName", hozAlign:"left", headerSort:false, visible:false},
					{title: /*[[#{taxpayer.id}]]*/ "Taxpayer Id", field:"taxpayerId", hozAlign:"left", headerSort:false, visible:false },
					{title: /*[[#{taxpayer.name}]]*/ "Taxpayer Name", field:"taxpayerName", hozAlign:"left", headerSort:false},
					{title: /*[[#{account.outlier.value}]]*/ "Value", field:"value", formatter: decimalFormatter, hozAlign:"right", headerSort:false},					
				]
			});
		}
		
	</script>
</body>
</html>